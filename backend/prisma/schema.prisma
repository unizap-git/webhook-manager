// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid()) @db.VarChar(30)
  name        String?
  email       String   @unique
  password    String
  accountType String   @default("PARENT") @map("account_type") @db.VarChar(20)
  parentId    String?  @map("parent_id") @db.VarChar(30)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  parent             User?               @relation("ParentChild", fields: [parentId], references: [id], onDelete: Cascade)
  childAccounts      User[]              @relation("ParentChild")
  projects           Project[]           @relation("ProjectOwner")
  projectAccess      ProjectAccess[]     @relation("UserAccess")
  grantedAccess      ProjectAccess[]     @relation("UserGrantedBy")
  userVendorChannels UserVendorChannel[]
  messages           Message[]
  analyticsCache     AnalyticsCache[]
  outboundMessages   OutboundMessage[]

  @@map("users")
}

model Vendor {
  id          String  @id @default(cuid()) @db.VarChar(30)
  name        String  @unique @db.VarChar(50)
  slug        String  @unique @db.VarChar(50)
  description String?
  isActive    Boolean @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  userVendorChannels UserVendorChannel[]
  messages           Message[]
  analyticsCache     AnalyticsCache[]
  outboundMessages   OutboundMessage[]

  @@map("vendors")
}

model Channel {
  id          String  @id @default(cuid()) @db.VarChar(30)
  name        String  @unique @db.VarChar(50)
  type        String  @db.VarChar(20)
  description String?
  isActive    Boolean @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  userVendorChannels UserVendorChannel[]
  messages           Message[]
  analyticsCache     AnalyticsCache[]
  outboundMessages   OutboundMessage[]

  @@map("channels")
}

model UserVendorChannel {
  id            String  @id @default(cuid()) @db.VarChar(30)
  userId        String  @map("user_id") @db.VarChar(30)
  vendorId      String  @map("vendor_id") @db.VarChar(30)
  channelId     String  @map("channel_id") @db.VarChar(30)
  projectId     String  @map("project_id") @db.VarChar(30)
  webhookUrl    String  @unique @map("webhook_url") @db.VarChar(255)
  webhookSecret String? @map("webhook_secret")
  isActive      Boolean @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor  Vendor  @relation(fields: [vendorId], references: [id])
  channel Channel @relation(fields: [channelId], references: [id])
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, vendorId, channelId, projectId])
  @@map("user_vendor_channels")
}

model Message {
  id             String    @id @default(cuid()) @db.VarChar(30)
  userId         String    @map("user_id") @db.VarChar(30)
  vendorId       String    @map("vendor_id") @db.VarChar(30)
  channelId      String    @map("channel_id") @db.VarChar(30)
  projectId      String    @map("project_id") @db.VarChar(30)
  recipient      String    @db.VarChar(100)
  messageId      String?   @map("message_id") @db.VarChar(100)
  contentSummary String?   @map("content_summary")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor  Vendor  @relation(fields: [vendorId], references: [id])
  channel Channel @relation(fields: [channelId], references: [id])
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  events  MessageEvent[]

  // Indexes for analytics queries
  @@index([userId, createdAt])
  @@index([userId, projectId, createdAt])
  @@index([vendorId])
  @@index([channelId])
  @@index([userId, vendorId, channelId, messageId])
  @@map("messages")
}

model MessageEvent {
  id           String   @id @default(cuid()) @db.VarChar(30)
  messageId    String   @map("message_id") @db.VarChar(30)
  vendorRefId  String?  @map("vendor_ref_id") @db.VarChar(100)
  status       String   @db.VarChar(20)
  reason       String?  @db.VarChar(255)
  timestamp    DateTime @default(now())
  rawPayload   String?  @map("raw_payload") @db.Text

  // Denormalized fields for query optimization (eliminates JOINs)
  userId       String?  @map("user_id") @db.VarChar(30)
  vendorId     String?  @map("vendor_id") @db.VarChar(30)
  channelId    String?  @map("channel_id") @db.VarChar(30)
  projectId    String?  @map("project_id") @db.VarChar(30)

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  // Indexes for analytics queries
  @@index([messageId, timestamp])
  @@index([messageId])
  @@index([status])
  @@index([vendorRefId])
  @@index([userId, status, timestamp])
  @@index([userId, vendorId, channelId, projectId, status])
  @@index([userId, vendorId, channelId, timestamp])
  @@index([userId, vendorId, channelId, projectId, timestamp])
  @@map("message_events")
}

model AnalyticsCache {
  id             String   @id @default(cuid()) @db.VarChar(30)
  userId         String   @map("user_id") @db.VarChar(30)
  vendorId       String?  @map("vendor_id") @db.VarChar(30)
  channelId      String?  @map("channel_id") @db.VarChar(30)
  projectId      String?  @map("project_id") @db.VarChar(30)
  date           DateTime
  totalSent      Int      @default(0) @map("total_sent")
  totalDelivered Int      @default(0) @map("total_delivered")
  totalRead      Int      @default(0) @map("total_read")
  totalFailed    Int      @default(0) @map("total_failed")
  successRate    Float    @default(0) @map("success_rate")
  lastUpdated    DateTime @updatedAt @map("last_updated")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor  Vendor?  @relation(fields: [vendorId], references: [id])
  channel Channel? @relation(fields: [channelId], references: [id])
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, vendorId, channelId, projectId, date])
  @@map("analytics_cache")
}

model Project {
  id          String   @id @default(cuid()) @db.VarChar(30)
  name        String   @db.VarChar(100)
  description String?
  userId      String   @map("user_id") @db.VarChar(30)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  owner              User                @relation("ProjectOwner", fields: [userId], references: [id], onDelete: Cascade)
  projectAccess      ProjectAccess[]
  userVendorChannels UserVendorChannel[]
  messages           Message[]
  analyticsCache     AnalyticsCache[]
  outboundMessages   OutboundMessage[]

  @@unique([name, userId])
  @@map("projects")
}

model ProjectAccess {
  id         String   @id @default(cuid()) @db.VarChar(30)
  projectId  String   @map("project_id") @db.VarChar(30)
  userId     String   @map("user_id") @db.VarChar(30)
  accessType String   @map("access_type") @db.VarChar(20)
  grantedBy  String   @map("granted_by") @db.VarChar(30)
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation("UserAccess", fields: [userId], references: [id], onDelete: Cascade)
  grantedByUser User @relation("UserGrantedBy", fields: [grantedBy], references: [id])

  @@unique([projectId, userId])
  @@map("project_access")
}

// Outbound Message Logging - for tracking messages sent by users
model OutboundMessage {
  id          String   @id @default(cuid()) @db.VarChar(30)
  userId      String   @map("user_id") @db.VarChar(30)
  projectId   String   @map("project_id") @db.VarChar(30)
  vendorId    String   @map("vendor_id") @db.VarChar(30)
  channelId   String   @map("channel_id") @db.VarChar(30)
  vendorRefId String   @map("vendor_ref_id") @db.VarChar(100)
  recipient   String   @db.VarChar(100)
  content     String   @db.Text
  sentAt      DateTime @map("sent_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  vendor  Vendor  @relation(fields: [vendorId], references: [id])
  channel Channel @relation(fields: [channelId], references: [id])

  // Indexes for efficient matching and queries
  @@index([vendorRefId])
  @@index([userId, projectId, sentAt])
  @@index([userId, vendorId, channelId])
  @@map("outbound_messages")
}
